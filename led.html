<!doctype html>
<html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <title>LED controller</title>
        <link rel="stylesheet" type="text/css" href="/static/angularjs-slider/dist/rzslider.css"/>
        <script src="/static/angular/angular.js"></script>
        <script src="/static/angularjs-slider/dist/rzslider.js"></script>
        <script src="/static/led-controller.js" type="text/javascript"></script>
        <script src="/static/led.js" type="text/javascript"></script>

        <script type="text/javascript">
        // Color wheel
        var colors;
        window.onload = function () {
            var out = document.getElementById("output"),
                reg = /^#(.)\1(.)\2(.)\3$/;
            
            // this is where colorpicker created
            var cp = Raphael.colorpicker(40, 20, 300, "#eee", picker2);
          
            // assigning onchange event handler
            cp.onchange = function (clr) {
                var confus;
                var red = (hexToRgb(clr).r);
                var calcr = red*16;
                var green = (hexToRgb(clr).g);
                var calcg = green*16;
                var blue = (hexToRgb(clr).b);
                var calcb = blue*16;
                var obj = {0: calcr, 1: calcg, 2: calcb}
                confus = JSON.stringify(obj);
                console.log(confus)
                ws.send(confus);
                colors = clr;
            };

            // Convert hex to rgb
            function hexToRgb(hex) {
                var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            };
        };

        // Convert rgb values 0, 1, 2 to hex
        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        };

        function rgbToHex(r, g, b) {
            return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
        };

        // Websockets
        var ws = null;
        colors = colors;
        function init(colors) {
            colors = colors;
            if ("WebSocket" in window) {
                ws = new WebSocket("ws://" + location.hostname + ":8000/ws");
                ws.onopen = function() {
                    console.log("Connection is opened");
                }
                ws.onclose = function() {
                    console.log("Connection is closed");
                }
                ws.onmessage = function(msg, colors) {
                    document.getElementById("display").innerHTML = msg.data;

                    // Converting received color information into hex
                    colors = JSON.parse(msg.data)
                    hex = rgbToHex(colors[0]/16, colors[1]/16, colors[2]/16)
                    console.log(hex)
                    document.getElementById("output").style.backgroundColor = hex;
                }    
            } else {
                console.log('Your browser doenst support WebSocket!')
            }
        }
        </script>   

    </head>
    <body onload="init();"  ng-app="led-controller" ng-controller="LedController as led">
    <div>
    <a href="/static/debug.html">Debug</a>
        <div style="background-color: goldenrod;" id="picker2"></div>
        <div id="output">
        <p id="display"></p>
    </div>
    <div style="margin-top: 350px">
    <button class="btn" ng-click="led.on()">Turn on</button>
    <div>
        <rzslider
         rz-slider-model="slider.value"
         rz-slider-options="{floor: 0, ceil: 100}"></rzslider>
    </div>
  </div>
        <!--<div id="fill" style="height: 20px; width: 20px; background-color: black;"></div>-->
    </body>
</html>
